# SQL性能分析

MySQL 客户端连接成功后，通过 `show[session | global status`命令可以提供服务器状态信息。通过如下指令，可以查看当前数据库的INSERT、UPDATE、DELETE、SELECT的访问频次:

`SHOW GLOBAL STATUS LIKE 'Com_______'`

## 慢查询日志

慢查询日志记录了所有执行时间超过指定参数(long_query_time，单位:秒，默认10秒)的所有SQL语句的日志。MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件(/etc/my.cnf)中配置如下信息:

- 开启MySQL慢日志查询开关
`slow_query log=1`
- 设置慢日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志
`long_query_time=2`

配置完毕之后，通过以下指令重新启动MySQL服务器进行测试，查看慢日志文件中记录的信息/var/lib/mysql/localhost-slow.log。

## profile
>![[Pasted image 20240227151311.png]]

## explain执行计划

**EXPLAIN 执行计划各字段含义:**
ld
- select查询的序列号，表示查询中执行select子句或者是操作表的顺序(id相同，执行顺序从上到下;id不同，值越大，越先执行)。
select type
- 表示 SELECT 的类型，常见的取值有 SIMPLE(简单表，即不使用表连接或者子查询)、PRIMARY(主查询，即外层的查询)UNION(UNION中的第二个或者后面的查询语句)、SUBOUERY(SELECT/WHERE之后包含了子查询)等
type
- 表示连接类型，性能由好到差的连接类型为`NULL、system、const、eq_ref、ref、range、index、all` 。
possible key
- 显示可能应用在这张表上的索引，一个或多个。
Key
- 实际使用的索引，如果为NULL，则没有使用索引。
Key len
- 表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好
rows
- MySQL认为必须要执行查询的行数，在innodb引擎的表中，是一个估计值，可能并不总是准确的
filtered
- 表示返回结果的行数占需读取行数的百分比，filtered 的值越大越好

## 索引使用

#### 索引失效
**1.最左前缀法则**
如果索引了多列(联合索引)，要遵守最左前缀法则。最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。如果跳跃某一列，索引将部分失效(后面的字段索引失效).


**2.范围查询**

>![[Pasted image 20240227175907.png]]

尽量加上等于号,使得索引中的字段全部生效.

**3.字符串不加引号**
字符串类型字段使用时，不加引号，索引将失效.

**4.用or连接的条件**
用or分割开的条件，如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到。

**5.数据分布影响**
如果MySQL评估使用索引比全表更慢，则不使用索引;

#### SQL提示

>![[Pasted image 20240227183712.png]]

##### 覆盖索引

尽量使用覆盖索引(查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到)，减少select * 的使用. 

**知识小贴士:**
- usingindex condition:查找使用了索引，但是需要回表查询数据
- using where; using index:查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询数据

##### 前缀索引
当字段类型为字符串(varchar，text等)时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只将字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率。

`create index idx_XXX on table_name(column(n));`

**前缀长度**
可以根据索引的选择性来决定，而选择性是指不重复的索引值(基数)和数据表的记录总数的比值，索引选择性越高则查询效率越高唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的。

计算前缀长度
`select count(distinct substring(字段,起始,终止))/count(*) from 表名`

##### 索引使用

单列索引与联合索引
单列索引:即一个索引只包含单个列。
联合索引:即一个索引包含了多个列。
在业务场景中，如果存在多个查询条件，考虑针对于查询字段建立索引时，建议建立联合索引，而非单列索引。

**多条件联合查询时，MySQL优化器会评估哪个字段的索引效率更高，会选择该索引完成本次查询。**


##### 索引使用原则

![[Pasted image 20240227195016.png]]



